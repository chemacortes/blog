<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Chema Cortés">
  <meta name="description" content="Codificando en binario | A raiz de la consulta de un colega, me ha llamado la atención el módulo binascii. Este módulo se encarga de la codificación...">

  <link rel="stylesheet" type="text/css" href="https://chemacortes.github.io/blog/theme/css/styles.425931e9.min.css">

  <script src="https://chemacortes.github.io/blog/theme/js/scripts.7db5858b.min.js" type="text/javascript"></script>

  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">

  <link href="https://chemacortes.github.io/blog//blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Hyperreals *R Full Atom Feed" />

<meta name="keywords" content="functional programming, lambda calculus, math, programación, programming, tip, unicode">

  <title>Codificando en binario | Hyperreals *R</title>

</head>

<body>
  <aside>
    <div id="user_meta">
      <a href="https://chemacortes.github.io/blog">
        <img src="https://s.gravatar.com/avatar/b20d114964d6d77c209aadbe9a152e87?s=80" id="logo">
      </a>
      <h2><a href="https://chemacortes.github.io/blog" class="nohover">Hyperreals *R</a></h2>
      <p>Quarks, bits y otras criaturas infinitesimales</p>
      <div class="social">
          <a href="https://twitter.com/chemacortes" title="twitter" target="_blank" rel="noopener noreferrer"><i class="fa fa-twitter fa-lg"></i></a>
          <a href="https://github.com/chemacortes" title="github" target="_blank" rel="noopener noreferrer"><i class="fa fa-github fa-lg"></i></a>
          <a href="https://bitbucket.org/chemacortes/" title="bitbucket" target="_blank" rel="noopener noreferrer"><i class="fa fa-bitbucket fa-lg"></i></a>
          <a href="https://stackoverflow.com/users/1243400/chemacortes" title="stackoverflow" target="_blank" rel="noopener noreferrer"><i class="fa fa-stack-overflow fa-lg"></i></a>
          <a href="https://linkedin.com/in/chemacortes" title="linkedin" target="_blank" rel="noopener noreferrer"><i class="fa fa-linkedin fa-lg"></i></a>
      </div>
      <ul>
        <li><a href="/feeds/all.atom.xml" target="_blank" rel="noopener noreferrer">All Feeds<i class="fa fa-external-link-square fa-lg"></i></a></li>
        <li><a href="/feeds/scala.atom.xml" target="_blank" rel="noopener noreferrer">Scala Feeds<i class="fa fa-external-link-square fa-lg"></i></a></li>
        <li><a href="/feeds/python.atom.xml" target="_blank" rel="noopener noreferrer">Python Feeds<i class="fa fa-external-link-square fa-lg"></i></a></li>
        <li><a href="/feeds/notas.atom.xml" target="_blank" rel="noopener noreferrer">Notas Feeds<i class="fa fa-external-link-square fa-lg"></i></a></li>
        <li><a href="https://mathstodon.xyz/@chemacortes" target="_blank" rel="noopener noreferrer">Mastodon<i class="fa fa-external-link-square fa-lg"></i></a></li>
      </ul>
    </div>
  </aside>

  <main id="main">
    <header>
      <p id="header">
      <a href="https://chemacortes.github.io/blog">Home</a>

      &#124; <a href="https://chemacortes.github.io/blog/pages/aboutme/">Quién&nbsp;soy</a>
      &#124; <a href="https://chemacortes.github.io/blog/pages/busqueda-python-es/">Búsqueda&nbsp;python-es</a>
      &#124; <a href="https://chemacortes.github.io/blog//blog/feeds/all.atom.xml">Atom Feed</a>
      </p>
<p>
<a href="https://chemacortes.github.io/blog/index.html">Posts</a>
&#124; <a href="https://chemacortes.github.io/blog/tag/">Tags</a>
&#124; <a href="https://chemacortes.github.io/blog/category/">Categories</a>
&#124; <a href="https://chemacortes.github.io/blog/archives.html">Archive</a>
</p>    </header>

<article>
<div class="article_meta">
  <p>Posted <time data-reltime datetime="2012-01-26T20:24:00+01:00">jue 26 enero 2012</time>
   by Chema Cortés  </p>
  <p>
  Category: <a href="https://chemacortes.github.io/blog/category/python/">Python</a>
&ndash;&ndash;  Tags:
    <a href="https://chemacortes.github.io/blog/tag/tip/">tip</a>,    <a href="https://chemacortes.github.io/blog/tag/unicode/">unicode</a>  </p>
</div>  <div class="article_title">
    <h1><a href="https://chemacortes.github.io/blog/2012/01/26/condificando-en-binario/" class="nohover">Codificando en&nbsp;binario</a></h1>
  </div>
  <div class="article_text">
    <p>A raiz de la consulta de un colega, me ha llamado la atención el módulo <code>binascii</code>. Este módulo se encarga de la codificación y decodificación de cadenas binarias para su transmisión en mensajes de texto. Lo habitual es que sea usado por otros módulos como <code>uu</code>, <code>base64</code> o <code>binhex</code>, por lo que no es nada frecuente ver su uso directo en una&nbsp;aplicación.</p>
<p>Sin embargo, <code>binascii</code> posee algunas funciones que pueden sernos bastante útiles a la hora de simplificar el empaquetado de datos que requieren determinadas APIs, en lugar de usar estructuras más complejas como <code>array</code> o <code>struct</code>. También se revela muy útil a la hora de crear batería de tests donde necesitemos chequear valores&nbsp;binarios.</p>
<h2>Estructuras array y&nbsp;struct</h2>
<p>Por ejemplo, imaginemos que nuestra <span class="caps">API</span> nos pide que empaquetemos un número entero como cuatro bytes. Antes de python3 no existía una forma para controlar el tamaño en bytes de un objeto sin tener que recurrir a alguna estructura especializada. Por&nbsp;ejemplo:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">array</span> <span class="kn">import</span> <span class="n">array</span>

<span class="k">def</span> <span class="nf">numpack</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
    <span class="n">a</span><span class="o">=</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;L&#39;</span><span class="p">)</span>
    <span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="n">tostring</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="n">n</span><span class="o">=</span><span class="n">numpack</span><span class="p">(</span><span class="mh">0xffeeddcc</span><span class="p">)</span>  <span class="c1"># res: \xff\xee\xdd\xcc</span>
</code></pre></div>

<p>En el resultado final ha hecho falta invertir el orden de los bytes debido a que nos estaba usando un orden <em>&#8220;little-endian&#8221;</em> para su codificación. El orden puede depender del sistema donde estemos trabajando, con lo que no es nada seguro usar este método. Es preferible el uso más especializado de <code>struct</code> donde tendremos algo más de control sobre éste y muchos otros&nbsp;aspectos:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">struct</span> <span class="kn">import</span> <span class="n">pack</span>

<span class="k">def</span> <span class="nf">numpack</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">pack</span><span class="p">(</span><span class="s1">&#39;!L&#39;</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>

<span class="n">n</span><span class="o">=</span><span class="n">numpack</span><span class="p">(</span><span class="mh">0xffeeddcc</span><span class="p">)</span>  <span class="c1"># res: \xff\xee\xdd\xcc</span>
</code></pre></div>

<p>Nota que en la cadena de formato que se pasa a <code>pack()</code> tiene un indicador <code>'!'</code> al principio, con el que indicamos que queremos una ordenación <em>&#8220;network (=big-endian)&#8221;</em>.</p>
<p>El proceso inverso es tan fácil como usar la función complementaria <code>unpack</code>:</p>
<div class="highlight"><pre><span></span><code><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;!L&#39;</span><span class="p">,</span> <span class="n">n</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div>

<h2>Codificando&nbsp;mensajes</h2>
<p>Lo visto hasta ahora funciona bien cuando tenemos que interaccionar con una <span class="caps">API</span> que use tamaños fijos para los datos. Pero, ¿qué pasa cuando los datos son de longitud variable, por ejemplo, un mensaje largo de decenas de bytes? En el mejor de los casos, tendríamos que ir byte a byte, tal vez apoyándonos en <code>array</code> o <code>struct</code> para realizar las conversiones, algo a todas luces resulta bastante&nbsp;tedioso.</p>
<p>Como ya adelanté, el módulo <code>binascii</code> nos va a ayudar en este cometido, en concreto la función <code>b2a_hex</code> y su contraparte <code>a2b_hex</code>.</p>
<p>Por ejemplo, nos envían en un mensaje un entero codificado en multibyte. No sabemos si son 2, 4 u 8 bytes, o incluso podrían ser más bytes de tratarse de un <code>BigInt</code> (entero muy largo). Con <code>binascii</code> podríamos resolverlo&nbsp;así:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">binascii</span> <span class="kn">import</span> <span class="n">b2a_hex</span><span class="p">,</span> <span class="n">a2b_hex</span>

<span class="n">num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">b2a_hex</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
</code></pre></div>

<p>Para el proceso contrario, codificar un entero en una cadena binaria, usaríamos <code>a2b_hex</code>:</p>
<div class="highlight"><pre><span></span><code><span class="n">h</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%x</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">num</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">h</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">h</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span> <span class="o">+</span> <span class="n">h</span>

<span class="n">msg</span> <span class="o">=</span> <span class="n">a2b_hex</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
</code></pre></div>

<p>Hemos tenido cuidado de que la cadena hexadecimal tenga longitud par ya que <code>a2b_hex</code> codifica siempre cada byte a partir de una pareja de dígitos&nbsp;hexadecimales.</p>
<h2>Estudio codificaciones&nbsp;unicode</h2>
<p>También es posible usar <code>binascii</code> para estudiar las codificaciones de cadenas unicode, lo que hace más sencillo crear tests automáticos para funciones que empleen unicode. Sin muchos adornos, haríamos algo&nbsp;así:</p>
<div class="highlight"><pre><span></span><code><span class="c1">#-*- coding: utf-8 -*-</span>

<span class="kn">from</span> <span class="nn">binascii</span> <span class="kn">import</span> <span class="n">b2a_hex</span><span class="p">,</span> <span class="n">a2b_hex</span>

<span class="n">cadena</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&quot;Peón </span><span class="se">\N{BLACK CHESS PAWN}</span><span class="s2">&quot;</span>

<span class="nb">print</span> <span class="n">b2a_hex</span><span class="p">(</span><span class="n">cadena</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>

<span class="c1">#res: 5065c3b36e20e2999f</span>
</code></pre></div>

<p>Comparando el resultado obtenido con la cadena unicode, vemos que la <em>ó</em> acentuada se codifica en &#8216;utf-8&#8217; como <code>0xc3b3</code>, o que la figura de peón negro se codifica como <code>0xe2999f</code>.</p>
<p>Si cambiamos la codificación por &#8216;utf-16&#8217; obtenermos como resultado <code>fffe50006500f3006e0020005f26</code>. Además de ser más larga, vemos que se añade al principio <code>fffe</code>, que es lo que se denomina <abbr title="Byte Order Mark"><span class="caps">BOM</span></abbr>, y que nos indica qué ordenación de bytes se ha usado en la codificación (<code>'FEFF'</code> para <em>Big Endian</em> / <code>'FFFE'</code> para <em>Little Endian</em>). Con <code>fffe</code> nos indica concretamente que se ha usado la codificación &#8216;<span class="caps">UTF</span>-16 Little Endian&#8217;, con lo que tenemos los bytes invertidos para cada caracter codificado (ver más info en el <a href="http://es.wikipedia.org/wiki/Marca_de_orden_de_bytes_(BOM)">artículo sobre <abbr title="Byte Order Mark"><span class="caps">BOM</span></abbr></a> de la&nbsp;wikipedia).</p>
<p>De no desear que se nos añada la marca <abbr title="Byte Order Mark"><span class="caps">BOM</span></abbr>, podríamos haber forzado la codificación mediante <code>'utf-16be'</code> ó <code>'utf-16le'</code> para <em>Big Endian</em> y <em>Little Endian</em>,&nbsp;respectivamente.</p>
  </div>

  <div id="article_comments">
    <div id="disqus_thread">
    </div>
  </div>

  <script id="dsq-count-scr" src="https://hyperreals.disqus.com/count.js" async></script>
  <script type="text/javascript">
    var disqus_config = function () {
        this.page.identifier = "2012/01/26/condificando-en-binario/";
        this.page.title = "Codificando en&nbsp;binario";
    };
    loadDisqus = function(sitename) {
      var d = document, s = d.createElement('script');
      s.src = 'https://hyperreals.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    };
    loadDisqus();
  </script>
</article>


    <div id="ending_message">
        <p>&copy; Chema Cortés. Built using <a href="http://getpelican.com">Pelican</a>. Theme is <a href="https://github.com/pR0Ps/pelican-subtle">subtle</a> by <a href="http://cmetcalfe.ca">Carey Metcalfe</a>. Based on <a href="https://github.com/giulivo/pelican-svbhack">svbhack</a> by Giulio Fidente.</p>
    </div>
  </main>

  <script type="text/javascript">
    window.addEventListener('load', skipHeader)
  </script>


</body>
</html>