<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Chema Cortés">
  <meta name="description" content="Problemas con los nombres largos en NTFS | Un buen día comenté a un compañero de trabajo que en su carpeta compartida del...">

  <link rel="stylesheet" type="text/css" href="https://blog.ch3m4.org/theme/css/styles.ea57ac74.min.css">

  <script src="https://blog.ch3m4.org/theme/js/scripts.ab06d70e.min.js" type="text/javascript"></script>

  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">

  <link href="https://blog.ch3m4.org/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Hyperreals *R Full Atom Feed" />

<meta name="keywords" content="functional programming, programming, programación, lambda calculus, math, ntfs, windows">

  <title>Problemas con los nombres largos en NTFS | Hyperreals *R</title>

</head>

<body>
  <aside>
    <div id="user_meta">
      <a href="https://blog.ch3m4.org">
        <img src="https://s.gravatar.com/avatar/b20d114964d6d77c209aadbe9a152e87?s=80" id="logo">
      </a>
      <h2><a href="https://blog.ch3m4.org" class="nohover">Hyperreals *R</a></h2>
      <p>Quarks, bits y otras criaturas infinitesimales</p>
      <div class="social">
          <a href="https://twitter.com/chemacortes" title="twitter" target="_blank" rel="noopener noreferrer"><i class="fa fa-twitter fa-lg"></i></a>
          <a href="https://github.com/chemacortes" title="github" target="_blank" rel="noopener noreferrer"><i class="fa fa-github fa-lg"></i></a>
          <a href="https://bitbucket.org/chemacortes/" title="bitbucket" target="_blank" rel="noopener noreferrer"><i class="fa fa-bitbucket fa-lg"></i></a>
          <a href="https://stackoverflow.com/users/1243400/chemacortes" title="stackoverflow" target="_blank" rel="noopener noreferrer"><i class="fa fa-stack-overflow fa-lg"></i></a>
          <a href="https://linkedin.com/in/chemacortes" title="linkedin" target="_blank" rel="noopener noreferrer"><i class="fa fa-linkedin fa-lg"></i></a>
      </div>
      <ul>
        <li><a href="/feeds/all.atom.xml" target="_blank" rel="noopener noreferrer">All Feeds<i class="fa fa-external-link-square fa-lg"></i></a></li>
        <li><a href="/feeds/scala.atom.xml" target="_blank" rel="noopener noreferrer">Scala Feeds<i class="fa fa-external-link-square fa-lg"></i></a></li>
        <li><a href="/feeds/python.atom.xml" target="_blank" rel="noopener noreferrer">Python Feeds<i class="fa fa-external-link-square fa-lg"></i></a></li>
        <li><a href="https://www.coursera.org/user/9408450118c4cfeddff015451ed358b6" target="_blank" rel="noopener noreferrer">my coursera<i class="fa fa-external-link-square fa-lg"></i></a></li>
      </ul>
    </div>
  </aside>

  <main id="main">
    <header>
      <p id="header">
      <a href="https://blog.ch3m4.org">Home</a>

      &#124; <a href="https://blog.ch3m4.org/pages/aboutme/">Quién&nbsp;soy</a>
      &#124; <a href="https://blog.ch3m4.org/pages/busqueda-python-es/">Búsqueda&nbsp;python-es</a>
      &#124; <a href="https://blog.ch3m4.org/feeds/all.atom.xml">Atom Feed</a>
      </p>
<p>
<a href="https://blog.ch3m4.org/index.html">Posts</a>
&#124; <a href="https://blog.ch3m4.org/tag/">Tags</a>
&#124; <a href="https://blog.ch3m4.org/category/">Categories</a>
&#124; <a href="https://blog.ch3m4.org/archives.html">Archive</a>
</p>    </header>

<article>
<div class="article_meta">
  <p>Posted <time data-timeago datetime="2012-04-04T13:07:00+02:00">mié 04 abril 2012</time>
   by Chema Cortés  </p>
  <p>
  Category: <a href="https://blog.ch3m4.org/category/python/">Python</a>
&ndash;&ndash;  Tags:
    <a href="https://blog.ch3m4.org/tag/ntfs/">ntfs</a>,    <a href="https://blog.ch3m4.org/tag/windows/">windows</a>  </p>
</div>  <div class="article_title">
    <h1><a href="https://blog.ch3m4.org/2012/04/04/problemas-con-los-nombres-largos-en-ntfs/" class="nohover">Problemas con los nombres largos en <span class="caps">NTFS</span></a></h1>
  </div>
  <div class="article_text">
    <p>Un buen día comenté a un compañero de trabajo que en su carpeta compartida del servidor de ficheros pronto iba a tener problemas al usar nombres de carpetas demasiado largos. El explorador de ficheros ya se negaba a listas algunas carpetas y el problema iba a más con algunas herramientas (backups,&nbsp;antivirus,&#8230;).</p>
<p>La respuesta fue una pregunta: <em>¿Sería posible sacar un listado de todos los ficheros con ruta absoluta demasiado&nbsp;larga?</em></p>
<p>Después de dudar un rato (y comprobar que el comando <code>dir</code> no era válido para esta labor) , me decidí a averiguar si python sería capaza de realizar dicha tarea. Éste es el resultado de ése&nbsp;estudio.</p>
<h2>Problema con los nombres&nbsp;largos</h2>
<p>Resulta bastante chocante que la <span class="caps">API</span> de windows limite la máxima longitud para una ruta al valor de <strong>MAX_PATH</strong>, definido como 260 caracteres. Se trata únicamente de una limitación en la <span class="caps">API</span>, ya que el kernel de windows está preparado para manejar rutas muchísimo más largas. Como consecuencia, muchas aplicaciones fallan con rutas largas, desde los comandos de terminal hasta las utilidades gráficas del&nbsp;sistema.</p>
<p>Para evitar en parte este problema, podemos usar en nuestras aplicaciones las versiones <em>unicode</em> de las funciones <em><span class="caps">ANSI</span></em> de la <span class="caps">API</span>. Estas versiones unicode admiten como parámetros rutas de hasta 32.767 caracteres, suficientemente largas para un uso&nbsp;normal.</p>
<p>En en caso de la librería estándar de python, el módulo <code>os.path</code> (sinónimo de <code>os.ntpath</code> en windows) tiene buena cuenta de qué <span class="caps">API</span> invocar, según sea el caso. De un modo transparente, <strong>con sólo codificar las rutas en unicode evitaremos la limitación <code>MAX_PATH</code> en la longitud de las rutas</strong>.</p>
<h2>Codificación de rutas&nbsp;extendida</h2>
<p>Además de codificar las rutas en unicode, tenemos que indicar que se trata de una <em>ruta extendida</em> añadiendo el prefijo <code>'\\?\'</code> a una ruta absoluta. Por ejemplo, <code>"\\?\D:\ruta\muy\muy\larga"</code>. Como gran limitación, no se puede usar esta nomenclatura con rutas relativas, por lo que las rutas relativas siempre estarán limitadas a <code>MAX_PATH</code> como máxima&nbsp;longitud.</p>
<p>Es posible, también, indicar una ruta <abbr title="Universal Naming Convention"><span class="caps">UNC</span></abbr> (<em>Universal Naming Convention</em>) como <em>ruta extendida</em> como <code>\\?\server\share</code>, donde <code>server</code> sería el nombre del servidor y <code>share</code> el nombre de la carpeta&nbsp;compartida.</p>
<p>Para más información sobre las rutas extendidas, visitar la página web <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa365247%28v=vs.85%29.aspx" title="Naming Files, Paths, and Namespaces">Naming Files, Paths, and Namespaces</a> de <span class="caps">MSDN</span>.</p>
<h2>Script para listar ficheros de nombres muy&nbsp;largos</h2>
<p>Por último, sólo queda lo más fácil: codificar el script&nbsp;;-)</p>
<p>Es común que la codificación que lleva por defecto la cónsola de comandos falle con las cadenas unicode. Si pensamos sacar por cónsola los nombres de ficheros, lo recomendable es cambiar la codificación por una más apropiada, como la <code>cp1252</code>, lo más aproximado a <code>utf-8</code> que podemos&nbsp;encontrar:</p>
<div class="highlight"><pre><span></span><code>    C:\&gt; chcp 1252
</code></pre></div>

<p>Para hacer nuestro script, podríamos haber usado cualquiera de las funciones <code>os.walk</code> de la librería estándar; pero, no sé porqué, fallan a crear la lista de directorios. Ésto nos obliga a crear nuestro propio método para recorrer la jerarquía de&nbsp;directorios.</p>
<p>Por comodidad, voy a lanzar el script en una máquina distinta de la que hace de servidor de ficheros ya que no dispongo de python en los servidores. Usaré la nomenclatura <abbr title="Universal Naming Convention"><span class="caps">UNC</span></abbr> para identificar los recursos&nbsp;compartidos.</p>
<div class="highlight"><pre><span></span><code><span class="c1">#-*- coding: utf-8 -*-</span>

<span class="kn">import</span> <span class="nn">os</span>

<span class="n">MAX_PATH</span><span class="o">=</span><span class="mi">260</span>

<span class="k">def</span> <span class="nf">longnames</span><span class="p">(</span><span class="n">dirpath</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Iterador que devuelve las rutas largas (&gt;=MAX_PATH)&quot;&quot;&quot;</span>

    <span class="c1">#Hay que forzar unicode para evitar el límite MAX_PATH</span>
    <span class="n">dirpath</span><span class="o">=</span><span class="n">unicode</span><span class="p">(</span><span class="n">dirpath</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dirpath</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">):</span>
        <span class="n">dirpath</span><span class="o">+=</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span>

    <span class="n">dirs</span><span class="o">=</span><span class="p">[]</span>

    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">dirpath</span><span class="p">):</span>

        <span class="n">name</span> <span class="o">=</span> <span class="n">dirpath</span><span class="o">+</span><span class="n">f</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">&gt;=</span><span class="n">MAX_PATH</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">name</span>

        <span class="c1">#poblar la lista de directorios</span>
        <span class="c1">#para recorrer en orden</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="n">dirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dirs</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">longnames</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">f</span>

<span class="k">def</span> <span class="nf">listshare</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">share</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Crea un UNC para el recurso compartido.</span>
<span class="sd">       Devuelve un iterador para las rutas largas (&gt;=MAX_PATH)</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">dirpath</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">?\UNC\</span><span class="si">%s</span><span class="s2">\</span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">share</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">longnames</span><span class="p">(</span><span class="n">dirpath</span><span class="p">)</span>
</code></pre></div>

<p>Su uso simple podía&nbsp;ser:</p>
<div class="highlight"><pre><span></span><code><span class="c1">#-*- coding: utf-8 -*-</span>

<span class="kn">import</span> <span class="nn">codecs</span>

<span class="c1">#PARÁMETROS</span>
<span class="n">SERVER</span><span class="o">=</span><span class="s2">&quot;MiServidor&quot;</span>
<span class="n">SHARE</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;Usuario\dir1&quot;</span>

<span class="n">fOut</span><span class="o">=</span><span class="n">codecs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;longnames.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">listshare</span><span class="p">(</span><span class="n">SERVER</span><span class="p">,</span><span class="n">SHARE</span><span class="p">):</span>

    <span class="nb">print</span> <span class="n">name</span>
    <span class="nb">print</span> <span class="o">&gt;&gt;</span><span class="n">fOut</span><span class="p">,</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">DIRPATH</span><span class="p">,</span><span class="s2">&quot;.</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">fOut</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>
  </div>

<ul class="pager">
  <li class="previous">
    <a href="https://blog.ch3m4.org/2012/02/07/estudio-funcion-factorial-en-scala-revision-funcional/" title="Anterior">
      <i class="fa fa-arrow-circle-left"></i>
      Estudio función factorial en scala - Revisión&nbsp;funcional
    </a>
  </li>
   <li class="next">
    <a href="https://blog.ch3m4.org/2012/05/12/lingua-franca/" title="Siguiente">
      Lingua&nbsp;Franca
      <i class="fa fa-arrow-circle-right"></i>
    </a>
  </li>
</ul>
With category
<a href="https://blog.ch3m4.org/category/python/">Python</a>:
<ul class="pager">
  <li class="previous">
    <a
      href="https://blog.ch3m4.org/2012/01/26/condificando-en-binario/"
      title="Anterior en misma categoría"
    >
      <i class="fa fa-arrow-circle-o-left"></i>
      Codificando en&nbsp;binario
    </a>
  </li>
   <li class="next">
    <a
      href="https://blog.ch3m4.org/2012/06/05/descriptores-parte-3/"
      title="Siguiente en misma categoría"
    >
      Descriptores - Parte&nbsp;3
      <i class="fa fa-arrow-circle-o-right"></i>
    </a>
  </li>
</ul>

  <div id="article_comments">
    <div id="disqus_thread">
    </div>
  </div>

  <script id="dsq-count-scr" src="https://hyperreals.disqus.com/count.js" async></script>
  <script type="text/javascript">
    var disqus_config = function () {
        this.page.identifier = "2012/04/04/problemas-con-los-nombres-largos-en-ntfs/";
        this.page.title = "Problemas con los nombres largos en <span class="caps">NTFS</span>";
    };
    loadDisqus = function(sitename) {
      var d = document, s = d.createElement('script');
      s.src = 'https://hyperreals.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    };
    loadDisqus();
  </script>
</article>


    <div id="ending_message">
        <p>&copy; Chema Cortés. Built using <a href="http://getpelican.com">Pelican</a>. Theme is <a href="https://github.com/pR0Ps/pelican-subtle">subtle</a> by <a href="http://cmetcalfe.ca">Carey Metcalfe</a>. Based on <a href="https://github.com/giulivo/pelican-svbhack">svbhack</a> by Giulio Fidente.</p>
    </div>
  </main>

  <script type="text/javascript">
    window.addEventListener('load', skipHeader)
  </script>


<script type="text/javascript">window.addEventListener("load", lw_timeago);</script>
</body>
</html>