<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Chema Cortés">
  <meta name="description" content="Borrado de un descriptor (corrección de errores) | Tengo que hacer algunas correcciones a la serie de artículos sobre descriptores, en concreto...">

  <link rel="stylesheet" type="text/css" href="https://chemacortes.github.io/blog/theme/css/styles.425931e9.min.css">

  <script src="https://chemacortes.github.io/blog/theme/js/scripts.7db5858b.min.js" type="text/javascript"></script>

  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">

  <link href="https://chemacortes.github.io/blog/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Hyperreals *R Full Atom Feed" />

<meta name="keywords" content="functional programming, lambda calculus, math, programación, programming, descriptor, técnicas dinámicas">

  <title>Borrado de un descriptor (corrección de errores) | Hyperreals *R</title>

</head>

<body>
  <aside>
    <div id="user_meta">
      <a href="https://chemacortes.github.io/blog">
        <img src="https://s.gravatar.com/avatar/b20d114964d6d77c209aadbe9a152e87?s=80" id="logo">
      </a>
      <h2><a href="https://chemacortes.github.io/blog" class="nohover">Hyperreals *R</a></h2>
      <p>Quarks, bits y otras criaturas infinitesimales</p>
      <div class="social">
          <a href="https://twitter.com/chemacortes" title="twitter" target="_blank" rel="noopener noreferrer"><i class="fa fa-twitter fa-lg"></i></a>
          <a href="https://github.com/chemacortes" title="github" target="_blank" rel="noopener noreferrer"><i class="fa fa-github fa-lg"></i></a>
          <a href="https://bitbucket.org/chemacortes/" title="bitbucket" target="_blank" rel="noopener noreferrer"><i class="fa fa-bitbucket fa-lg"></i></a>
          <a href="https://stackoverflow.com/users/1243400/chemacortes" title="stackoverflow" target="_blank" rel="noopener noreferrer"><i class="fa fa-stack-overflow fa-lg"></i></a>
          <a href="https://linkedin.com/in/chemacortes" title="linkedin" target="_blank" rel="noopener noreferrer"><i class="fa fa-linkedin fa-lg"></i></a>
      </div>
      <ul>
        <li><a href="/feeds/all.atom.xml" target="_blank" rel="noopener noreferrer">All Feeds<i class="fa fa-external-link-square fa-lg"></i></a></li>
        <li><a href="/feeds/scala.atom.xml" target="_blank" rel="noopener noreferrer">Scala Feeds<i class="fa fa-external-link-square fa-lg"></i></a></li>
        <li><a href="/feeds/python.atom.xml" target="_blank" rel="noopener noreferrer">Python Feeds<i class="fa fa-external-link-square fa-lg"></i></a></li>
        <li><a href="/feeds/notas.atom.xml" target="_blank" rel="noopener noreferrer">Notas Feeds<i class="fa fa-external-link-square fa-lg"></i></a></li>
        <li><a href="https://mathstodon.xyz/@chemacortes" target="_blank" rel="noopener noreferrer">Mastodon<i class="fa fa-external-link-square fa-lg"></i></a></li>
      </ul>
    </div>
  </aside>

  <main id="main">
    <header>
      <p id="header">
      <a href="https://chemacortes.github.io/blog">Home</a>

      &#124; <a href="https://chemacortes.github.io/blog/pages/aboutme/">Quién&nbsp;soy</a>
      &#124; <a href="https://chemacortes.github.io/blog/pages/busqueda-python-es/">Búsqueda&nbsp;python-es</a>
      &#124; <a href="https://chemacortes.github.io/blog/blog/feeds/all.atom.xml">Atom Feed</a>
      </p>
<p>
<a href="https://chemacortes.github.io/blog/index.html">Posts</a>
&#124; <a href="https://chemacortes.github.io/blog/tag/">Tags</a>
&#124; <a href="https://chemacortes.github.io/blog/category/">Categories</a>
&#124; <a href="https://chemacortes.github.io/blog/archives.html">Archive</a>
</p>    </header>

<article>
<div class="article_meta">
  <p>Posted <time data-reltime datetime="2013-07-13T14:00:00+02:00">sáb 13 julio 2013</time>
   by Chema Cortés  </p>
  <p>Last updated <time data-reltime datetime="2018-07-25T01:30:02+02:00">mié 25 julio 2018</time></p>
  <p>
  Category: <a href="https://chemacortes.github.io/blog/category/python/">Python</a>
&ndash;&ndash;  Tags:
    <a href="https://chemacortes.github.io/blog/tag/descriptor/">descriptor</a>,    <a href="https://chemacortes.github.io/blog/tag/tecnicas-dinamicas/">técnicas dinámicas</a>  </p>
</div>  <div class="article_title">
    <h1><a href="https://chemacortes.github.io/blog/2013/07/13/borrado-de-un-descriptor-correccion-de-errores/" class="nohover">Borrado de un descriptor (corrección de&nbsp;errores)</a></h1>
  </div>
  <div class="article_text">
    <p>Tengo que hacer algunas correcciones a la serie de artículos sobre <em>descriptores</em>, en concreto sobre el método <code>__delete__</code> del protocolo <em>descriptor</em>.</p>
<p>Primero, aclaremos cómo funciona el método <code>__delete__</code> y en qué se diferencia de <code>__del__</code>. No se trata de métodos <em>destructores</em> tal y como se entiende en otros lenguajes de programación orientados a objeto. En python, <strong>todo objeto está vivo mientras esté referenciado</strong>. Sólo cuando se pierda la última referencia se procederá a la destrucción y borrado del objeto en memoria por parte del <em>recolector de basura</em>.</p>
<p>Por ejemplo, veamos el siguiente&nbsp;código:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Miclase</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s2">&quot;instance deleted&quot;</span>

<span class="n">a</span> <span class="o">=</span> <span class="n">Miclase</span><span class="p">()</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">a</span>
<span class="k">del</span> <span class="n">a</span>

<span class="nb">print</span> <span class="n">b</span>
<span class="nb">print</span> <span class="s2">&quot;Come on&quot;</span>
<span class="n">b</span> <span class="o">=</span> <span class="mi">1</span>
<span class="nb">print</span> <span class="s2">&quot;END&quot;</span>
</code></pre></div>

<p>De su ejecución, podemos comprobar que el método <code>__del__</code> no se invoca justo en el momento de hacer <code>del a</code>, si no cuando se pierde la última referencia al asignar otro valor a la variable <code>b</code>. La sentencia <code>del a</code> no <em>destruye</em> el objeto, tan sólo desliga el objeto de la etiqueta <code>a</code> que lo referenciaba. Por ese motivo, es inexacto hablar en python de &#8220;variable de memoria&#8221;, como se entiende en otro lenguajes. Tan sólo cambiamos de una referencia de un objeto a otro, sin destruir su valor&nbsp;anterior.</p>
<h2>Revisión del protocolo&nbsp;descriptor</h2>
<p>En un <a href="https://chemacortes.github.io/blog/2011/06/19/descriptores-parte-1/">anterior artículo</a> distinguía entre descriptores de datos y de no-datos. Hay que aclarar que un descriptor de datos &#8220;es también el que sólo tiene definido un método <code>__delete__</code>, aunque no tenga método <code>__set__</code><span class="dquo">&#8220;</span>. ¿Para qué puede sernos útil tener uno sin el&nbsp;otro?</p>
<p>Un descriptor de datos sin método <code>__set__</code> no tiene forma de impedir que el atributo/método que implementa sea sustituído por otro objeto (por ejemplo, por otro descriptor). El método <code>__delete__</code> nos daría la última opción de liberar recursos que ya no vayamos a usar antes de desaparecer el descriptor. Pero, independiemente de lo que haga, el método <code>__delete__</code> indicaría que el descriptor puede ser sustituido. En definitiva, se comportaría como un <em>descriptor de no-datos</em>, pero con las diferencias en la invocación entre estos dos tipos de descriptor<sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup>.</p>
<p>Para aclarar las cosas, veamos qué estaba mal en el <a href="https://chemacortes.github.io/blog/2011/06/19/descriptores-parte-1/">ejemplo</a> que puse en su momento  sobre el uso de <code>__delete__</code> (he cambiado algunos nombres para que se vea más&nbsp;claro):</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Desc</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mul</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mul</span> <span class="o">=</span> <span class="n">mul</span>

    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mul</span>

    <span class="k">def</span> <span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span>

    <span class="k">def</span> <span class="fm">__delete__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">del</span> <span class="bp">self</span>

<span class="k">class</span> <span class="nc">Miclase</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="n">a12</span> <span class="o">=</span> <span class="n">Desc</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">a200</span> <span class="o">=</span> <span class="n">Desc</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>


<span class="n">c</span> <span class="o">=</span> <span class="n">Miclase</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="nb">print</span> <span class="n">c</span><span class="o">.</span><span class="n">a12</span> <span class="c1">#--&gt; 24</span>

<span class="n">c</span><span class="o">.</span><span class="n">a12</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># ERROR: AttributeError</span>

<span class="k">del</span> <span class="n">Miclase</span><span class="o">.</span><span class="n">a12</span>
<span class="n">c</span><span class="o">.</span><span class="n">a12</span><span class="o">=</span><span class="mi">100</span>

<span class="nb">print</span> <span class="n">c</span><span class="o">.</span><span class="n">a12</span>  <span class="c1">#--&gt; 100 (no descriptor)</span>
</code></pre></div>

<p>La idea era que se pudiera borrar el descriptor de datos para sustuirlo por otro valor. Tal como señalaba Cristian en un comentario al respecto, este ejemplo parece funcionar con o sin el método <code>__delete__</code> en el&nbsp;descriptor.</p>
<p>Funciona siempre debido a que con <code>'del Miclase.a12'</code> estamos borrando la referencia al descriptor que tiene la clase, sin pasar por el protocolo descriptor. La particularidad de los descriptores es que <em>viven</em> en la clase, pero se invocan desde la instancia. Con <code>'del Miclase.a12'</code> estamos saltándonos el protocolo descriptor para acceder directamente al atributo de la clase<sup id="fnref:2"><a class="footnote-ref" href="#fn:2">2</a></sup>.</p>
<p>Además, este código no funcionaría&nbsp;nunca:</p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="fm">__delete__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">del</span> <span class="bp">self</span>
</code></pre></div>

<p>Si la idea era borrar el objeto <code>self</code>, referencia al descriptor, podemos quitarnos esa idea ya que el comando <code>del</code> borra la referencia del <em>scope</em> local donde se encuentra. <strong>¡No es un destructor!</strong> En realidad, todas las variables locales son borradas al finalizar el método. En este caso en concreto, también la variable local <code>obj</code> será borrada aunque no se indique&nbsp;explícitamente.</p>
<p>Otra cuestión a tener en cuenta es que los atributos de clase son compartidos por todas sus instancias. Si en algún momento alteramos un descriptor (por ejemplo, borrándolo), entonces todas las instancias sufririan el mismo cambio. No parece que sea el efecto&nbsp;buscado.</p>
<p>La gran pregunta es <em>entonces, ¿cómo podemos aprovecharnos del método <code>__delete__</code>?</em></p>
<p>Para sacarle algún partido, el descriptor debería comportarse de forma distinta según sea la instancia que lo invoca. Definido así el descriptoor, entonces podríamos usar el método <code>__delete__</code> para simular el borrado del atributo para esa instancia, sin que el descriptor pierda su&nbsp;funcionalidad.</p>
<p>Un ejemplo para ilustrar ésto&nbsp;sería:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">weakref</span> <span class="kn">import</span> <span class="n">WeakKeyDictionary</span>

<span class="k">class</span> <span class="nc">Desc</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">WeakKeyDictionary</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span>
        <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="n">total</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="fm">__delete__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">Miclase</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="n">value</span> <span class="o">=</span> <span class="n">Desc</span><span class="p">()</span>


<span class="n">a</span> <span class="o">=</span> <span class="n">Miclase</span><span class="p">()</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">Miclase</span><span class="p">()</span>

<span class="n">a</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">b</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">5</span>

<span class="nb">print</span> <span class="n">a</span><span class="o">.</span><span class="n">value</span>  <span class="c1">#--&gt; (2, 7)</span>
<span class="nb">print</span> <span class="n">b</span><span class="o">.</span><span class="n">value</span>  <span class="c1">#--&gt; (5, 7)</span>

<span class="n">a</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># ERROR: AttributeError</span>

<span class="k">del</span> <span class="n">a</span><span class="o">.</span><span class="n">value</span>
<span class="n">a</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">11</span>

<span class="nb">print</span> <span class="n">a</span><span class="o">.</span><span class="n">value</span>  <span class="c1">#--&gt; (11, 16)</span>
<span class="nb">print</span> <span class="n">b</span><span class="o">.</span><span class="n">value</span>  <span class="c1">#--&gt; (5, 16)</span>

<span class="k">del</span> <span class="n">b</span>

<span class="nb">print</span> <span class="n">a</span><span class="o">.</span><span class="n">value</span>  <span class="c1">#--&gt; (11, 11)</span>
</code></pre></div>

<p>El descriptor mantiene un diccionario <em>weak</em> con valores asignados para cada instancia de la clase. Usamos para ello un <em>WeakKeyDictionary</em> que tiene la particularidad de relajar la referencia al objeto, de modo que si todas las referencias al objeto son borradas en el programa, también es borrada la referencia que conservaba el&nbsp;diccionario.</p>
<p>En este ejemplo, el método <code>__get__</code> devuelve el valor del atributo si el objeto está en el diccionario, si no da error. El método <code>__set__</code> asigna un valor al atributo sólo si el objeto no existe. Para ver mejor el funcionamiento, el método <code>__get__</code> devuelve una tupla con el valor del atributo y la suma de todos los&nbsp;atributos.</p>
<p>Ejecuntado el ejemplo, creamos dos instancias y les asignamos un valor al atributo controlado por el descriptor. Una vez asignado un valor, ya no podemos cambiarlo. La única opción será borrar el atributo y volverlo a&nbsp;asignar.</p>
<p>También se puede comprobar que, cuando borramos el objeto <code>b</code>, la suma de todos los atributos se actualiza a las instancias que aún quedan <em>vivas</em>.</p>
<p>En el borrado del atributo se usa el método <code>__delete__</code> del descriptor; en el borrado de la instancia, el método <code>__del__</code> (si&nbsp;existiera).</p>
<h2>Referencia</h2>
<p>No quisiera acabar este artículo sin añadir una referencia sobre este tema que os recomiendo leer, con algunas recetas para aprovechar el uso de los&nbsp;descriptores:</p>
<p><a href="http://nbviewer.jupyter.org/gist/ChrisBeaumont/5758381/descriptor_writeup.ipynb"><span class="dquo">&#8220;</span>Python Descriptors Demystified&#8221;</a> by <a href="http://chrisbeaumont.org/">Chris&nbsp;Beaumont</a></p>
<div class="footnote">
<hr>
<ol>
<li id="fn:1">
<p>Comentado en los anteriores <a href="https://chemacortes.github.io/blog/tag/descriptor/">artículos sobre descriptores</a>.&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>Un modo de impedir el borrado de atributos de una clase sería aplicando el protocolo descriptor con metaclases, pero pienso que estaríamos complicándolo todo demasiado para el beneficio que pudiera obtenerse a cambio.&#160;<a class="footnote-backref" href="#fnref:2" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
</ol>
</div>
  </div>

  <div id="article_comments">
    <div id="disqus_thread">
    </div>
  </div>

  <script id="dsq-count-scr" src="https://hyperreals.disqus.com/count.js" async></script>
  <script type="text/javascript">
    var disqus_config = function () {
        this.page.identifier = "2013/07/13/borrado-de-un-descriptor-correccion-de-errores/";
        this.page.title = "Borrado de un descriptor (corrección de&nbsp;errores)";
    };
    loadDisqus = function(sitename) {
      var d = document, s = d.createElement('script');
      s.src = 'https://hyperreals.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    };
    loadDisqus();
  </script>
</article>


    <div id="ending_message">
        <p>&copy; Chema Cortés. Built using <a href="http://getpelican.com">Pelican</a>. Theme is <a href="https://github.com/pR0Ps/pelican-subtle">subtle</a> by <a href="http://cmetcalfe.ca">Carey Metcalfe</a>. Based on <a href="https://github.com/giulivo/pelican-svbhack">svbhack</a> by Giulio Fidente.</p>
    </div>
  </main>

  <script type="text/javascript">
    window.addEventListener('load', skipHeader)
  </script>


</body>
</html>